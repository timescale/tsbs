# TSBS Supplemental Guide: Apache IoTDB

**This should be read *after* the main README.**

Apache IoTDB (Database for Internet of Things) is an IoT native database with
high performance for data management and analysis, deployable on the edge and
the cloud. For more details about Apache IoTDB, please take a look at:
[https://iotdb.apache.org/](https://iotdb.apache.org/)

This supplemental guide explains how the data generated for TSBS is stored,
additional flags available when using the data importer (`tsbs_load_iotdb`),
and additional flags available for the query runner (`tsbs_run_queries_iotdb`).

## Data format

Data generated by `tsbs_generate_data` for IoTDB is serialized in a "pseudo-CSV"
format, along with a custom header at the beginning:

* one line composed of a comma-separated list of "deviceID" and field names
* one line composed of a comma-separated list of deviceID and field values
* one line composed of a comma-separated list of "datatype" and data types
* one line composed of a comma-separated list of tags

For example:

```text
deviceID,timestamp,<fieldName1>,<fieldName2>,<fieldName3>,...
<deviceID>,<timestamp>,<field1>,<field2>,<field3>,...
datatype,<datatype1>,<datatype2>,<datatype3>,...
tags,<tagName1>=<tagValue1>,<tagName2>=<tagValue2>,...

deviceID,timestamp,hostname,value
root.cpu.host_1,1451606400000000000,'host_1',44.0
datatype,5,2
tags,region='eu-west-1',datacenter='eu-west-1c',rack='87',
```

`deviceID` describes the storage path which is composed of several nodes.
IoTDB uses storage groups to manage data. For example, in test case `devops`,
if `measurementName` is `cpu` while `hostname` tag is `host_0`, then `deviceID`
is `root.cpu.host_0`.
`hostname` in `devops` test cases is one of primary keys, and each `hostname`
specifies a unique device, so it's selected to be part of `deviceID`. But other
tags are not so important and their values do not change during whole testing,
so they are designed to be stored in a node named `_tags` as attributes.
For more detail about how IoTDB manage attributes of a node, please take a look
at [Timeseries Management](https://iotdb.apache.org/UserGuide/Master/Operate-Metadata/Timeseries.html#create-timeseries).

The unit of timestamp in generated data is nanosecond, but it will be converted
into millisecond before insert into database.

An example for the `cpu-only` use case:

```text
deviceID,timestamp,usage_user,usage_system,usage_idle,usage_nice,usage_iowait,usage_irq,usage_softirq,usage_steal,usage_guest,usage_guest_nice
root.cpu.host_0,1451606400000000000,58,2,24,61,22,63,6,44,80,38
datatype,2,2,2,2,2,2,2,2,2,2
tags,region='eu-west-1',datacenter='eu-west-1c',rack='87',os='Ubuntu16.04LTS',arch='x64',team='NYC',service='18',service_version='1',service_environment='production'

```

---

## CSV Export

`tsbs_load_iotdb` provides CSV export function. User can export any test cases
into CSV files. In this method, `tsbs_load_iotdb` will NOT open any session,
and will NOT connect to database. It will create some CSV files and store data
into them instead. The amount of CSV files is equal to the amount of storage
groups. For example, if `sacle==4000` in `devops` test cases, there will be
`4,000 * 9 = 36,000` storage groups and 36,000 CSV files.

An example for a CSV file:

```text
Time,root.cpu.host_0.usage_user(INT64),root.cpu.host_0.usage_system(INT64),root.cpu.host_0.usage_idle(INT64),root.cpu.host_0.usage_nice(INT64),root.cpu.host_0.usage_iowait(INT64),root.cpu.host_0.usage_irq(INT64),root.cpu.host_0.usage_softirq(INT64),root.cpu.host_0.usage_steal(INT64),root.cpu.host_0.usage_guest(INT64),root.cpu.host_0.usage_guest_nice(INT64)
1451606400000,58,2,24,61,22,63,6,44,80,38
1451606460000,58,1,24,62,22,61,7,48,80,38
1451606520000,59,0,24,63,21,61,6,48,79,38
1451606580000,59,1,25,62,22,60,6,49,80,36
1451606640000,58,1,24,62,22,60,8,49,80,35
1451606700000,58,2,24,62,21,61,8,48,79,36
```

In this CSV file, the data aligned by time, and headers with data type. For more
information about this format, please take a look at
[Sample CSV file to be imported](https://iotdb.apache.org/UserGuide/Master/Write-Data/CSV-Tool.html#sample-csv-file-to-be-imported).

---

## `tsbs_load_iotdb` Additional Flags

### IoTDB related

#### `-host` (type: `string`, default: `localhost`)

Hostname of IoTDB instance.

#### `-port` (type: `string`, default: `6667`)

Which port to connect to on the database host.

#### `-user` (type: `string`, default: `root`)

The username of user who connect to IoTDB.

#### `-password` (type: `string`, default: `root`)

The password for user connecting to IoTDB.

#### `-timeout` (type: `int`, default: `0`)

Session timeout check in millisecond. After session config initialization,
client will try to get response from database server to make sure the connection
is established. This argument is the session timeout in millisecond. Use 0 for
no timeout.

#### `-records-max-rows` (type: `int`, default: `0`)

Session use `insertRecords` to insert data into database. This argument is the
max size (max rows) of records. Use 0 for no limit. If this argument is 0,
`tsbs_load_iotdb` will insert all data in a batch at one time, that means the
behavior is equal to setting this arguments as `batch-size`.

**Warning!** If this value is set too small, the insertion performance will be
seriously reduced.

#### `-to-csv` (type: `bool`, default: `false`)

This argument is relative to CSV export function. If this argument is `false`,
then `tsbs_load_iotdb` will insert data into IoTDB database. Else it will
generate CSV files locally without any connect to database. Therefore, if this
argument is `true`, 6 arguments are meaningless.

**Warning!** While this argument is `true`, do NOT set `worker` more than 1.
Because file writing is a sequential operation.

#### `-csv-prefix` (type: `string`, default: `./`)

This is prefix of filepath for CSV files. Specific a folder or a folder with
filename prefix.
For example, if it's set to `/home/`, all exported CSV files will be stored in
folder `/home/`, like this:

```text
|-- home
    |-- root.cpu.host_0.csv
    |-- root.cpu.host_1.csv
    |-- root.cpu.host_2.csv
    |-- root.cpu.host_3.csv
    ...
    |-- root.disk.host_0.csv
    |-- root.disk.host_1.csv
    |-- root.disk.host_2.csv
    ...
```

For another example, if it's set to `/home/iotdb-data-`, all exported CSV files
will be stored in folder `/home/` with prefix `iotdb-data-`, like this:

```text
|-- home
    |-- iotdb-data-root.cpu.host_0.csv
    |-- iotdb-data-root.cpu.host_1.csv
    |-- iotdb-data-root.cpu.host_2.csv
    |-- iotdb-data-root.cpu.host_3.csv
    ...
    |-- iotdb-data-root.disk.host_0.csv
    |-- iotdb-data-root.disk.host_1.csv
    |-- iotdb-data-root.disk.host_2.csv
    ...
```

**Warning!** `tsbs_load_iotdb` uses native string connection to complete above
works, so please make sure folders in those paths are exist. That means user
should create those folders manually.

#### `-aligned-timeseries` (type: `bool`, default: `true`)

Using aligned timeseries for all metrics if set true. That means using
InsertAlignedRecords, which is faster than InsertRecords.

#### `-store-tags` (type: `bool`, default: `false`)

Store tags if set true. Can NOT be used if `-aligned-timeseries` is set true.
That's because IoTDB do NOT support 'attributes' and 'tags' for aligned
timeseries yet.

---

## `tsbs_run_queries_iotdb` Additional Flags

### IoTDB related

#### `-host` (type: `string`, default: `localhost`)

Hostname of IoTDB instance.

#### `-port` (type: `string`, default: `6667`)

Which port to connect to on the database host.

#### `-user` (type: `string`, default: `root`)

The username of user who connect to IoTDB.

#### `-password` (type: `string`, default: `root`)

The password for user connecting to IoTDB.
